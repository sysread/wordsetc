#!/usr/bin/env bash

set -eux -o pipefail

export MIX_ENV=prod
export APP="_build/prod/rel/words_etc/bin/words_etc"

# Ensure our database path exists
sudo mkdir -p "$(dirname "$DATABASE_PATH")"
sudo chown -Rf sysread "$(dirname "$DATABASE_PATH")"

# Install dependencies
sudo apt install -y libssl-dev automake autoconf libncurses5-dev

# Install erlang and elixir with asdf
source "$HOME/.asdf/asdf.sh"
asdf install

# Build our app release
mix local.hex --force
mix deps.get
mix release --overwrite

# Stop any existing instances of the app
if [[ -n "$($APP pid)" ]]; then
  $APP stop || true
fi

# Start our app
$APP daemon

# Wait for the app to start
sleep 5

if [[ -z "$($APP pid)" ]]; then
  echo "Application failed to start"
  exit 1
fi

exit 0
